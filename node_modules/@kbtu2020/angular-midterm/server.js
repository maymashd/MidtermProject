"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const json_server_1 = require("json-server");
const authorize_middleware_1 = require("./authorize.middleware");
const db_1 = require("./db");
const server = json_server_1.create();
const serverRouter = json_server_1.router(db_1.db);
const middlewares = json_server_1.defaults();
server.use(middlewares);
// To handle POST, PUT and PATCH you need to use a body-parser
// You can use the one used by JSON Server
server.use(json_server_1.bodyParser);
server.use(async (req, res, next) => {
    if (req.url.startsWith("/users") || req.url.startsWith("/sign-in")) {
        next();
        return;
    }
    if (await authorize_middleware_1.isAuthorized(req, db_1.db)) {
        next();
    }
    else {
        res.sendStatus(401);
    }
});
server.post("/sign-in", async (req, res) => {
    if (!req.body) {
        res.status(400).send({ error: "Use body to send {username, password}" });
    }
    else {
        const token = await authorize_middleware_1.authorize({
            username: req.body.username,
            password: req.body.password,
        }, db_1.db);
        if (token !== false) {
            res.send(token);
        }
        else {
            res.status(404).send({ error: "No such user or password is incorrect" });
        }
    }
});
server.get("/me", async (req, res) => {
    const credential = authorize_middleware_1.getCredentials(req);
    const user = authorize_middleware_1.findUser(credential, db_1.db);
    if (user) {
        res.status(200).json(user);
    }
    else {
        res.status(403).send({ error: 'User credentials invalid' });
    }
});
server.use(serverRouter);
server.listen(3000, () => {
    console.log("JSON Server is running");
});
